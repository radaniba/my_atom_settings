Object.defineProperty(exports, '__esModule', {
  value: true
});
exports.activate = activate;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _languagesJs = require('./languages.js');

var _languagesJs2 = _interopRequireDefault(_languagesJs);

var _atom = require('atom');

'use babel';

function activate() {
  atom.commands.add('atom-text-editor:not([mini])', {
    'block-comment-plus:toggle': toggle
  });
}

function toggle() {
  var editor = atom.workspace.getActiveTextEditor();
  var editorView = atom.views.getView(editor);
  var buffer = editor.getBuffer();
  var selections = editor.getSelections();

  buffer.transact(function () {
    for (i in selections) {
      var selection = selections[i];
      var selectionRange = selection.getBufferRange();
      var hasTextSelected = selection.getText().length > 0;
      var bufferRange = selection.getBufferRange();
      var startLanguage = getLanguage(bufferRange.start);
      var endLanguage = getLanguage(bufferRange.end);

      // defaults to C based comments
      var commentStart = '/*';
      var commentEnd = '*/';
      var addNewLine = false;

      if (startLanguage !== endLanguage || startLanguage === "plain") {
        continue;
      }
      var language = startLanguage;

      if (typeof _languagesJs2['default'][startLanguage] != 'undefined') {
        var lng = _languagesJs2['default'][startLanguage];
        commentStart = lng.start;
        commentEnd = lng.end;
        addNewLine = lng.newLine ? lng.newLine : false;
      }

      if (isInBlockComment(bufferRange.start) && isInBlockComment(bufferRange.end)) {
        var selectionText = selection.getText();

        if (selectionText.startsWith(commentStart) && selectionText.endsWith(commentEnd)) {
          var replaced = selectionText.trim().substr(commentStart.length);
          replaced = replaced.substr(0, replaced.length - commentEnd.length);
          selection.insertText(replaced, { select: true });
        } else {
          var startRow = searchCommentRow(bufferRange.start, commentStart, commentEnd, true);
          var foundStart = rowContainsCommentToken(startRow, commentStart);

          var endRow = searchCommentRow(bufferRange.end, commentStart, commentEnd);
          var foundEnd = rowContainsCommentToken(endRow, commentEnd);

          if (foundStart && foundEnd) {
            removeCommentToken(startRow, commentStart, addNewLine);

            if (addNewLine) endRow--;

            removeCommentToken(endRow, commentEnd, addNewLine);

            var _newSelectionRange = undefined;
            if (selection.getText().length > 0) {
              if (addNewLine) {
                _newSelectionRange = new _atom.Range(new _atom.Point(selectionRange.start.row - 1, 0), new _atom.Point(selectionRange.end.row - 1, selectionRange.end.column));
              } else {
                selectionRange.start.column -= commentStart.length;
                _newSelectionRange = selectionRange;
              }
              selection.setBufferRange(_newSelectionRange);
            }
          } else {
            atom.commands.dispatch(editorView, 'editor:toggle-line-comments');
          }
        }
      } else {
        var selectionText = selection.getText();
        var start = selectionText.trim().substr(0, commentStart.length);
        var end = selectionText.trim().substr(-1 * commentEnd.length);

        if (start === commentStart && end === commentEnd) {
          var replaced = selectionText.trim().substr(commentStart.length);
          replaced = replaced.substr(0, replaced.length - commentEnd.length);
          selection.insertText(replaced, { select: true });
        } else {
          var innerWrapper = addNewLine ? "\n" : "";
          selection.insertText(commentStart + innerWrapper + selectionText + innerWrapper + commentEnd + innerWrapper);

          if (hasTextSelected) {
            var _newSelectionRange2 = undefined;
            if (addNewLine) {
              _newSelectionRange2 = new _atom.Range(new _atom.Point(selectionRange.start.row + 1, 0), new _atom.Point(selectionRange.end.row + 1, buffer.lineForRow(selectionRange.end.row + 1).length));
            } else {
              var startPoint = new _atom.Point(selectionRange.start.row, selectionRange.start.column + commentStart.length);

              var endPoint = new _atom.Point(selectionRange.end.row, selectionRange.end.column);

              if (startPoint.row === endPoint.row) {
                endPoint.column += commentEnd.length;
              }

              _newSelectionRange2 = new _atom.Range(startPoint, endPoint);
            }

            selection.setBufferRange(_newSelectionRange2);
          } else {
            newSelectionRange = new _atom.Range(new _atom.Point(selectionRange.start.row, selectionRange.start.column + commentStart.length), new _atom.Point(selectionRange.end.row, selectionRange.end.column + commentEnd.length));

            selection.setBufferRange(newSelectionRange);
          }
        }
      }
    }
  });

  function getLanguage(point) {
    var scopes = editor.scopeDescriptorForBufferPosition(point).getScopesArray();
    var language = null;

    if (scopes.length > 1) {
      for (i in scopes) {
        var item = scopes[i];
        if (item.match(/source/g)) {
          var scope = item.split('.');
          language = scope[1];
          break;
        }
      }
    }

    if (language === null) {
      var scope = scopes[0].split('.');
      language = scope[1];
    }

    return language;
  }

  function isInBlockComment(point) {
    var scopes = editor.scopeDescriptorForBufferPosition(point).getScopesArray();
    var isCommented = false;

    if (scopes.length > 1) {
      for (i in scopes) {
        var scope = scopes[i];
        if (scope.match(/comment/g)) {
          isCommented = true;
          break;
        }
      }
    }

    return isCommented;
  }

  function searchCommentRow(point, startToken, endToken) {
    var backwards = arguments.length <= 3 || arguments[3] === undefined ? false : arguments[3];

    var end = backwards ? 0 : buffer.getLastRow();
    var stopIfFound = backwards ? endToken : startToken;
    var token = backwards ? startToken : endToken;
    var found = false;
    var row = point.row;

    if (backwards) {
      while (row >= 0) {
        var rowText = buffer.lineForRow(row);
        if (rowText.includes(stopIfFound)) {
          if (rowText.indexOf(token) > 0 && rowText.indexOf(stopIfFound) > rowText.indexOf(token)) {
            return point.row;
          }
        }
        if (rowText.includes(token)) {
          found = true;
          return row;
        }
        row--;
      }
    } else {
      while (row <= buffer.getLastRow()) {
        var rowText = buffer.lineForRow(row);
        if (rowText.includes(stopIfFound)) {
          if (rowText.indexOf(stopIfFound) < rowText.indexOf(token)) {
            return point.row;
          }
        }
        if (rowText.includes(token)) {
          found = true;
          return row;
        }
        row++;
      }
    }

    return end;
  }

  function rowContainsCommentToken(row, token) {
    var rowText = buffer.lineForRow(row);
    return rowText.includes(token);
  }

  function removeCommentToken(row, token, shouldDeleteRow) {
    var rowText = buffer.lineForRow(row);

    var replaceText = rowText.replace(token, '');
    var range = [[row, 0], [row, rowText.length]];

    buffer.setTextInRange(range, replaceText);

    if (shouldDeleteRow) {
      buffer.deleteRow(row);
    }

    return true;
  }

  function selectionIsEmpty(selection) {
    var br = selection.getBufferRange();
    return br.start.row === br.end.row && br.start.column === br.end.column;
  }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9SYWQvLmF0b20vcGFja2FnZXMvYmxvY2stY29tbWVudC1wbHVzL2xpYi9ibG9jay1jb21tZW50LXBsdXMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7OzsyQkFFc0IsZ0JBQWdCOzs7O29CQUNYLE1BQU07O0FBSGpDLFdBQVcsQ0FBQzs7QUFLTCxTQUFTLFFBQVEsR0FBRztBQUN6QixNQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyw4QkFBOEIsRUFBRTtBQUNoRCwrQkFBMkIsRUFBRSxNQUFNO0dBQ3BDLENBQUMsQ0FBQztDQUNKOztBQUVELFNBQVMsTUFBTSxHQUFHO0FBQ2hCLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztBQUNwRCxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUM5QyxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUM7QUFDbEMsTUFBTSxVQUFVLEdBQUcsTUFBTSxDQUFDLGFBQWEsRUFBRSxDQUFDOztBQUUxQyxRQUFNLENBQUMsUUFBUSxDQUFDLFlBQU07QUFDcEIsU0FBSyxDQUFDLElBQUksVUFBVSxFQUFFO0FBQ3BCLFVBQU0sU0FBUyxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNoQyxVQUFNLGNBQWMsR0FBRyxTQUFTLENBQUMsY0FBYyxFQUFFLENBQUM7QUFDbEQsVUFBTSxlQUFlLEdBQUcsU0FBUyxDQUFDLE9BQU8sRUFBRSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7QUFDdkQsVUFBSSxXQUFXLEdBQUcsU0FBUyxDQUFDLGNBQWMsRUFBRSxDQUFDO0FBQzdDLFVBQUksYUFBYSxHQUFHLFdBQVcsQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDbkQsVUFBSSxXQUFXLEdBQUcsV0FBVyxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FB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R0FBRyxDQUFDLENBQUM7S0FDdkI7O0FBRUQsV0FBTyxJQUFJLENBQUM7R0FDYjs7QUFFRCxXQUFTLGdCQUFnQixDQUFDLFNBQVMsRUFBRTtBQUNuQyxRQUFNLEVBQUUsR0FBRyxTQUFTLENBQUMsY0FBYyxFQUFFLENBQUM7QUFDdEMsV0FBTyxFQUFFLENBQUMsS0FBSyxDQUFDLEdBQUcsS0FBSyxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxFQUFFLENBQUMsS0FBSyxDQUFDLE1BQU0sS0FBSyxFQUFFLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQztHQUN6RTtDQUdGIiwiZmlsZSI6Ii9Vc2Vycy9SYWQvLmF0b20vcGFja2FnZXMvYmxvY2stY29tbWVudC1wbHVzL2xpYi9ibG9jay1jb21tZW50LXBsdXMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJztcblxuaW1wb3J0IGxhbmd1YWdlcyBmcm9tICcuL2xhbmd1YWdlcy5qcyc7XG5pbXBvcnQge1BvaW50LCBSYW5nZX0gZnJvbSAnYXRvbSc7XG5cbmV4cG9ydCBmdW5jdGlvbiBhY3RpdmF0ZSgpIHtcbiAgYXRvbS5jb21tYW5kcy5hZGQoJ2F0b20tdGV4dC1lZGl0b3I6bm90KFttaW5pXSknLCB7XG4gICAgJ2Jsb2NrLWNvbW1lbnQtcGx1czp0b2dnbGUnOiB0b2dnbGVcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHRvZ2dsZSgpIHtcbiAgY29uc3QgZWRpdG9yID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpO1xuICBjb25zdCBlZGl0b3JWaWV3ID0gYXRvbS52aWV3cy5nZXRWaWV3KGVkaXRvcik7XG4gIGNvbnN0IGJ1ZmZlciA9IGVkaXRvci5nZXRCdWZmZXIoKTtcbiAgY29uc3Qgc2VsZWN0aW9ucyA9IGVkaXRvci5nZXRTZWxlY3Rpb25zKCk7XG5cbiAgYnVmZmVyLnRyYW5zYWN0KCgpID0+IHtcbiAgICBmb3IgKGkgaW4gc2VsZWN0aW9ucykge1xuICAgICAgY29uc3Qgc2VsZWN0aW9uID0gc2VsZWN0aW9uc1tpXTtcbiAgICAgIGNvbnN0IHNlbGVjdGlvblJhbmdlID0gc2VsZWN0aW9uLmdldEJ1ZmZlclJhbmdlKCk7XG4gICAgICBjb25zdCBoYXNUZXh0U2VsZWN0ZWQgPSBzZWxlY3Rpb24uZ2V0VGV4dCgpLmxlbmd0aCA+IDA7XG4gICAgICBsZXQgYnVmZmVyUmFuZ2UgPSBzZWxlY3Rpb24uZ2V0QnVmZmVyUmFuZ2UoKTtcbiAgICAgIGxldCBzdGFydExhbmd1YWdlID0gZ2V0TGFuZ3VhZ2UoYnVmZmVyUmFuZ2Uuc3RhcnQpO1xuICAgICAgbGV0IGVuZExhbmd1YWdlID0gZ2V0TGFuZ3VhZ2UoYnVmZmVyUmFuZ2UuZW5kKTtcblxuICAgICAgLy8gZGVmYXVsdHMgdG8gQyBiYXNlZCBjb21tZW50c1xuICAgICAgbGV0IGNvbW1lbnRTdGFydCA9ICcvKic7XG4gICAgICBsZXQgY29tbWVudEVuZCA9ICcqLyc7XG4gICAgICBsZXQgYWRkTmV3TGluZSA9IGZhbHNlO1xuXG4gICAgICBpZiAoc3RhcnRMYW5ndWFnZSAhPT0gZW5kTGFuZ3VhZ2UgfHwgc3RhcnRMYW5ndWFnZSA9PT0gXCJwbGFpblwiKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgY29uc3QgbGFuZ3VhZ2UgPSBzdGFydExhbmd1YWdlO1xuXG4gICAgICBpZiAodHlwZW9mIGxhbmd1YWdlc1tzdGFydExhbmd1YWdlXSAhPSAndW5kZWZpbmVkJykge1xuICAgICAgICBsZXQgbG5nID0gbGFuZ3VhZ2VzW3N0YXJ0TGFuZ3VhZ2VdO1xuICAgICAgICBjb21tZW50U3RhcnQgPSBsbmcuc3RhcnQ7XG4gICAgICAgIGNvbW1lbnRFbmQgPSBsbmcuZW5kO1xuICAgICAgICBhZGROZXdMaW5lID0gbG5nLm5ld0xpbmUgPyBsbmcubmV3TGluZSA6IGZhbHNlO1xuICAgICAgfVxuXG4gICAgICBpZiAoaXNJbkJsb2NrQ29tbWVudChidWZmZXJSYW5nZS5zdGFydCkgJiYgaXNJbkJsb2NrQ29tbWVudChidWZmZXJSYW5nZS5lbmQpKSB7XG4gICAgICAgIGNvbnN0IHNlbGVjdGlvblRleHQgPSBzZWxlY3Rpb24uZ2V0VGV4dCgpO1xuXG4gICAgICAgIGlmIChzZWxlY3Rpb25UZXh0LnN0YXJ0c1dpdGgoY29tbWVudFN0YXJ0KSAmJiBzZWxlY3Rpb25UZXh0LmVuZHNXaXRoKGNvbW1lbnRFbmQpKSB7XG4gICAgICAgICAgbGV0IHJlcGxhY2VkID0gc2VsZWN0aW9uVGV4dC50cmltKCkuc3Vic3RyKGNvbW1lbnRTdGFydC5sZW5ndGgpO1xuICAgICAgICAgIHJlcGxhY2VkID0gcmVwbGFjZWQuc3Vic3RyKDAsIHJlcGxhY2VkLmxlbmd0aCAtIGNvbW1lbnRFbmQubGVuZ3RoKTtcbiAgICAgICAgICBzZWxlY3Rpb24uaW5zZXJ0VGV4dChyZXBsYWNlZCwge3NlbGVjdDogdHJ1ZX0pO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgIGNvbnN0IHN0YXJ0Um93ID0gc2VhcmNoQ29tbWVudFJvdyhidWZmZXJSYW5nZS5zdGFydCwgY29tbWVudFN0YXJ0LCBjb21tZW50RW5kLCB0cnVlKTtcbiAgICAgICAgICBjb25zdCBmb3VuZFN0YXJ0ID0gcm93Q29udGFpbnNDb21tZW50VG9rZW4oc3RhcnRSb3csIGNvbW1lbnRTdGFydCk7XG5cbiAgICAgICAgICBsZXQgZW5kUm93ID0gc2VhcmNoQ29tbWVudFJvdyhidWZmZXJSYW5nZS5lbmQsIGNvbW1lbnRTdGFydCwgY29tbWVudEVuZCk7XG4gICAgICAgICAgY29uc3QgZm91bmRFbmQgPSByb3dDb250YWluc0NvbW1lbnRUb2tlbihlbmRSb3csIGNvbW1lbnRFbmQpO1xuXG4gICAgICAgICAgaWYgKGZvdW5kU3RhcnQgJiYgZm91bmRFbmQpIHtcbiAgICAgICAgICAgIHJlbW92ZUNvbW1lbnRUb2tlbihzdGFydFJvdywgY29tbWVudFN0YXJ0LCBhZGROZXdMaW5lKTtcblxuICAgICAgICAgICAgaWYgKGFkZE5ld0xpbmUpIGVuZFJvdy0tO1xuXG4gICAgICAgICAgICByZW1vdmVDb21tZW50VG9rZW4oZW5kUm93LCBjb21tZW50RW5kLCBhZGROZXdMaW5lKTtcblxuICAgICAgICAgICAgbGV0IG5ld1NlbGVjdGlvblJhbmdlO1xuICAgICAgICAgICAgaWYgKHNlbGVjdGlvbi5nZXRUZXh0KCkubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICBpZiAoYWRkTmV3TGluZSkge1xuICAgICAgICAgICAgICAgIG5ld1NlbGVjdGlvblJhbmdlID0gbmV3IFJhbmdlKFxuICAgICAgICAgICAgICAgICAgbmV3IFBvaW50KHNlbGVjdGlvblJhbmdlLnN0YXJ0LnJvdyAtIDEsIDApLFxuICAgICAgICAgICAgICAgICAgbmV3IFBvaW50KHNlbGVjdGlvblJhbmdlLmVuZC5yb3cgLSAxLCBzZWxlY3Rpb25SYW5nZS5lbmQuY29sdW1uKVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgc2VsZWN0aW9uUmFuZ2Uuc3RhcnQuY29sdW1uIC09IGNvbW1lbnRTdGFydC5sZW5ndGhcbiAgICAgICAgICAgICAgICBuZXdTZWxlY3Rpb25SYW5nZSA9IHNlbGVjdGlvblJhbmdlO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHNlbGVjdGlvbi5zZXRCdWZmZXJSYW5nZShuZXdTZWxlY3Rpb25SYW5nZSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICB9XG4gICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBhdG9tLmNvbW1hbmRzLmRpc3BhdGNoKGVkaXRvclZpZXcsICdlZGl0b3I6dG9nZ2xlLWxpbmUtY29tbWVudHMnKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICBjb25zdCBzZWxlY3Rpb25UZXh0ID0gc2VsZWN0aW9uLmdldFRleHQoKTtcbiAgICAgICAgY29uc3Qgc3RhcnQgPSBzZWxlY3Rpb25UZXh0LnRyaW0oKS5zdWJzdHIoMCwgY29tbWVudFN0YXJ0Lmxlbmd0aCk7XG4gICAgICAgIGNvbnN0IGVuZCA9IHNlbGVjdGlvblRleHQudHJpbSgpLnN1YnN0cigtMSAqIGNvbW1lbnRFbmQubGVuZ3RoKTtcblxuICAgICAgICBpZiAoc3RhcnQgPT09IGNvbW1lbnRTdGFydCAmJiBlbmQgPT09IGNvbW1lbnRFbmQpIHtcbiAgICAgICAgICBsZXQgcmVwbGFjZWQgPSBzZWxlY3Rpb25UZXh0LnRyaW0oKS5zdWJzdHIoY29tbWVudFN0YXJ0Lmxlbmd0aCk7XG4gICAgICAgICAgcmVwbGFjZWQgPSByZXBsYWNlZC5zdWJzdHIoMCwgcmVwbGFjZWQubGVuZ3RoIC0gY29tbWVudEVuZC5sZW5ndGgpO1xuICAgICAgICAgIHNlbGVjdGlvbi5pbnNlcnRUZXh0KHJlcGxhY2VkLCB7c2VsZWN0OiB0cnVlfSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgY29uc3QgaW5uZXJXcmFwcGVyID0gYWRkTmV3TGluZSA/IFwiXFxuXCIgOiBcIlwiO1xuICAgICAgICAgIHNlbGVjdGlvbi5pbnNlcnRUZXh0KFxuICAgICAgICAgICAgY29tbWVudFN0YXJ0ICsgaW5uZXJXcmFwcGVyICtcbiAgICAgICAgICAgIHNlbGVjdGlvblRleHQgKyBpbm5lcldyYXBwZXIgK1xuICAgICAgICAgICAgY29tbWVudEVuZCArIGlubmVyV3JhcHBlclxuICAgICAgICAgICk7XG5cbiAgICAgICAgICBpZiAoaGFzVGV4dFNlbGVjdGVkKSB7XG4gICAgICAgICAgICBsZXQgbmV3U2VsZWN0aW9uUmFuZ2U7XG4gICAgICAgICAgICBpZiAoYWRkTmV3TGluZSkge1xuICAgICAgICAgICAgICAgIG5ld1NlbGVjdGlvblJhbmdlID0gbmV3IFJhbmdlKFxuICAgICAgICAgICAgICAgICAgbmV3IFBvaW50KHNlbGVjdGlvblJhbmdlLnN0YXJ0LnJvdyArIDEsIDApLFxuICAgICAgICAgICAgICAgICAgbmV3IFBvaW50KFxuICAgICAgICAgICAgICAgICAgICBzZWxlY3Rpb25SYW5nZS5lbmQucm93ICsgMSxcbiAgICAgICAgICAgICAgICAgICAgYnVmZmVyLmxpbmVGb3JSb3coc2VsZWN0aW9uUmFuZ2UuZW5kLnJvdyArIDEpLmxlbmd0aFxuICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBzdGFydFBvaW50ID0gbmV3IFBvaW50KFxuICAgICAgICAgICAgICAgICAgc2VsZWN0aW9uUmFuZ2Uuc3RhcnQucm93LFxuICAgICAgICAgICAgICAgICAgc2VsZWN0aW9uUmFuZ2Uuc3RhcnQuY29sdW1uICsgY29tbWVudFN0YXJ0Lmxlbmd0aFxuICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBlbmRQb2ludCA9IG5ldyBQb2ludChcbiAgICAgICAgICAgICAgICAgIHNlbGVjdGlvblJhbmdlLmVuZC5yb3csXG4gICAgICAgICAgICAgICAgICBzZWxlY3Rpb25SYW5nZS5lbmQuY29sdW1uXG4gICAgICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgICAgIGlmIChzdGFydFBvaW50LnJvdyA9PT0gZW5kUG9pbnQucm93KSB7XG4gICAgICAgICAgICAgICAgICBlbmRQb2ludC5jb2x1bW4gKz0gY29tbWVudEVuZC5sZW5ndGg7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgbmV3U2VsZWN0aW9uUmFuZ2UgPSBuZXcgUmFuZ2Uoc3RhcnRQb2ludCwgZW5kUG9pbnQpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBzZWxlY3Rpb24uc2V0QnVmZmVyUmFuZ2UobmV3U2VsZWN0aW9uUmFuZ2UpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIG5ld1NlbGVjdGlvblJhbmdlID0gbmV3IFJhbmdlKFxuICAgICAgICAgICAgICAgIG5ldyBQb2ludChcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0aW9uUmFuZ2Uuc3RhcnQucm93LFxuICAgICAgICAgICAgICAgICAgICBzZWxlY3Rpb25SYW5nZS5zdGFydC5jb2x1bW4gKyBjb21tZW50U3RhcnQubGVuZ3RoXG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICBuZXcgUG9pbnQoXG4gICAgICAgICAgICAgICAgICBzZWxlY3Rpb25SYW5nZS5lbmQucm93LFxuICAgICAgICAgICAgICAgICAgc2VsZWN0aW9uUmFuZ2UuZW5kLmNvbHVtbiArIGNvbW1lbnRFbmQubGVuZ3RoXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgc2VsZWN0aW9uLnNldEJ1ZmZlclJhbmdlKG5ld1NlbGVjdGlvblJhbmdlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH0pO1xuXG4gIGZ1bmN0aW9uIGdldExhbmd1YWdlKHBvaW50KSB7XG4gICAgY29uc3Qgc2NvcGVzID0gZWRpdG9yLnNjb3BlRGVzY3JpcHRvckZvckJ1ZmZlclBvc2l0aW9uKHBvaW50KS5nZXRTY29wZXNBcnJheSgpO1xuICAgIGxldCBsYW5ndWFnZSA9IG51bGw7XG5cbiAgICBpZiAoc2NvcGVzLmxlbmd0aCA+IDEpIHtcbiAgICAgIGZvciAoaSBpbiBzY29wZXMpIHtcbiAgICAgICAgY29uc3QgaXRlbSA9IHNjb3Blc1tpXTtcbiAgICAgICAgaWYgKGl0ZW0ubWF0Y2goL3NvdXJjZS9nKSkge1xuICAgICAgICAgIGxldCBzY29wZSA9IGl0ZW0uc3BsaXQoJy4nKTtcbiAgICAgICAgICBsYW5ndWFnZSA9IHNjb3BlWzFdO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGxhbmd1YWdlID09PSBudWxsKSB7XG4gICAgICBsZXQgc2NvcGUgPSBzY29wZXNbMF0uc3BsaXQoJy4nKTtcbiAgICAgIGxhbmd1YWdlID0gc2NvcGVbMV07XG4gICAgfVxuXG4gICAgcmV0dXJuIGxhbmd1YWdlO1xuICB9XG5cbiAgZnVuY3Rpb24gaXNJbkJsb2NrQ29tbWVudChwb2ludCkge1xuICAgIGNvbnN0IHNjb3BlcyA9IGVkaXRvci5zY29wZURlc2NyaXB0b3JGb3JCdWZmZXJQb3NpdGlvbihwb2ludCkuZ2V0U2NvcGVzQXJyYXkoKTtcbiAgICBsZXQgaXNDb21tZW50ZWQgPSBmYWxzZTtcblxuICAgIGlmIChzY29wZXMubGVuZ3RoID4gMSkge1xuICAgICAgZm9yIChpIGluIHNjb3Blcykge1xuICAgICAgICBsZXQgc2NvcGUgPSBzY29wZXNbaV07XG4gICAgICAgIGlmIChzY29wZS5tYXRjaCgvY29tbWVudC9nKSkge1xuICAgICAgICAgIGlzQ29tbWVudGVkID0gdHJ1ZTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBpc0NvbW1lbnRlZDtcbiAgfVxuXG4gIGZ1bmN0aW9uIHNlYXJjaENvbW1lbnRSb3cocG9pbnQsIHN0YXJ0VG9rZW4sIGVuZFRva2VuLCBiYWNrd2FyZHMgPSBmYWxzZSkge1xuICAgIGNvbnN0IGVuZCA9IGJhY2t3YXJkcyA/IDAgOiBidWZmZXIuZ2V0TGFzdFJvdygpO1xuICAgIGNvbnN0IHN0b3BJZkZvdW5kID0gYmFja3dhcmRzID8gZW5kVG9rZW4gOiBzdGFydFRva2VuO1xuICAgIGNvbnN0IHRva2VuID0gYmFja3dhcmRzID8gc3RhcnRUb2tlbiA6IGVuZFRva2VuO1xuICAgIGxldCBmb3VuZCA9IGZhbHNlO1xuICAgIGxldCByb3cgPSBwb2ludC5yb3c7XG5cbiAgICBpZiAoYmFja3dhcmRzKSB7XG4gICAgICB3aGlsZSAocm93ID49IDApIHtcbiAgICAgICAgbGV0IHJvd1RleHQgPSBidWZmZXIubGluZUZvclJvdyhyb3cpO1xuICAgICAgICBpZiAocm93VGV4dC5pbmNsdWRlcyhzdG9wSWZGb3VuZCkpIHtcbiAgICAgICAgICBpZiAocm93VGV4dC5pbmRleE9mKHRva2VuKSA+IDAgJiYgcm93VGV4dC5pbmRleE9mKHN0b3BJZkZvdW5kKSA+IHJvd1RleHQuaW5kZXhPZih0b2tlbikpIHtcbiAgICAgICAgICAgIHJldHVybiBwb2ludC5yb3c7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChyb3dUZXh0LmluY2x1ZGVzKHRva2VuKSkge1xuICAgICAgICAgIGZvdW5kID0gdHJ1ZTtcbiAgICAgICAgICByZXR1cm4gcm93O1xuICAgICAgICB9XG4gICAgICAgIHJvdy0tO1xuICAgICAgfVxuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIHdoaWxlIChyb3cgPD0gYnVmZmVyLmdldExhc3RSb3coKSkge1xuICAgICAgICBsZXQgcm93VGV4dCA9IGJ1ZmZlci5saW5lRm9yUm93KHJvdyk7XG4gICAgICAgIGlmIChyb3dUZXh0LmluY2x1ZGVzKHN0b3BJZkZvdW5kKSkge1xuICAgICAgICAgIGlmIChyb3dUZXh0LmluZGV4T2Yoc3RvcElmRm91bmQpIDwgcm93VGV4dC5pbmRleE9mKHRva2VuKSkge1xuICAgICAgICAgICAgcmV0dXJuIHBvaW50LnJvdztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJvd1RleHQuaW5jbHVkZXModG9rZW4pKSB7XG4gICAgICAgICAgZm91bmQgPSB0cnVlO1xuICAgICAgICAgIHJldHVybiByb3c7XG4gICAgICAgIH1cbiAgICAgICAgcm93Kys7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGVuZDtcbiAgfVxuXG4gIGZ1bmN0aW9uIHJvd0NvbnRhaW5zQ29tbWVudFRva2VuKHJvdywgdG9rZW4pIHtcbiAgICBjb25zdCByb3dUZXh0ID0gYnVmZmVyLmxpbmVGb3JSb3cocm93KTtcbiAgICByZXR1cm4gcm93VGV4dC5pbmNsdWRlcyh0b2tlbik7XG4gIH1cblxuICBmdW5jdGlvbiByZW1vdmVDb21tZW50VG9rZW4ocm93LCB0b2tlbiwgc2hvdWxkRGVsZXRlUm93KSB7XG4gICAgY29uc3Qgcm93VGV4dCA9IGJ1ZmZlci5saW5lRm9yUm93KHJvdyk7XG5cbiAgICBjb25zdCByZXBsYWNlVGV4dCA9IHJvd1RleHQucmVwbGFjZSh0b2tlbiwgJycpO1xuICAgIGNvbnN0IHJhbmdlID0gW1tyb3csIDBdLCBbcm93LCByb3dUZXh0Lmxlbmd0aF1dO1xuXG4gICAgYnVmZmVyLnNldFRleHRJblJhbmdlKHJhbmdlLCByZXBsYWNlVGV4dCk7XG5cbiAgICBpZiAoc2hvdWxkRGVsZXRlUm93KSB7XG4gICAgICBidWZmZXIuZGVsZXRlUm93KHJvdyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBmdW5jdGlvbiBzZWxlY3Rpb25Jc0VtcHR5KHNlbGVjdGlvbikge1xuICAgIGNvbnN0IGJyID0gc2VsZWN0aW9uLmdldEJ1ZmZlclJhbmdlKCk7XG4gICAgcmV0dXJuIGJyLnN0YXJ0LnJvdyA9PT0gYnIuZW5kLnJvdyAmJiBici5zdGFydC5jb2x1bW4gPT09IGJyLmVuZC5jb2x1bW47XG4gIH1cblxuXG59XG4iXX0=