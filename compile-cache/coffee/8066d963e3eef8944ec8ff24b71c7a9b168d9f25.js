(function() {
  var $, GitTimeplot, GitTimeplotPopup, RevisionView, View, _, d3, moment, ref;

  ref = require("atom-space-pen-views"), $ = ref.$, View = ref.View;

  _ = require('underscore-plus');

  moment = require('moment');

  d3 = require('d3');

  GitTimeplotPopup = require('./git-timeplot-popup');

  RevisionView = require('./git-revision-view');

  module.exports = GitTimeplot = (function() {
    function GitTimeplot(element) {
      this.element = element;
      this.$element = $(this.element);
      this._debouncedRenderPopup = _.debounce(this._renderPopup, 50);
      this._debouncedHidePopup = _.debounce(this._hidePopup, 50);
      this._debouncedViewNearestRevision = _.debounce(this._viewNearestRevision, 100);
    }

    GitTimeplot.prototype.hide = function() {
      var ref1;
      return (ref1 = this.popup) != null ? ref1.remove() : void 0;
    };

    GitTimeplot.prototype.show = function() {};

    GitTimeplot.prototype.render = function(editor, commitData) {
      var ref1, svg;
      this.editor = editor;
      this.commitData = commitData;
      if ((ref1 = this.popup) != null) {
        ref1.remove();
      }
      this.file = this.editor.getPath();
      this.$timeplot = this.$element.find('.timeplot');
      if (this.$timeplot.length <= 0) {
        this.$timeplot = $("<div class='timeplot'>");
        this.$element.append(this.$timeplot);
      }
      if (this.commitData.length <= 0) {
        this.$timeplot.html("<div class='placeholder'>No commits, nothing to see here.</div>");
        return;
      }
      svg = d3.select(this.$timeplot.get(0)).append("svg").attr("width", this.$element.width()).attr("height", 100);
      this._renderAxis(svg);
      this._renderBlobs(svg);
      this._renderHoverMarker();
      return this.$timeplot;
    };

    GitTimeplot.prototype._renderAxis = function(svg) {
      var h, left_pad, maxDate, maxHour, minDate, minHour, pad, w, xAxis, yAxis;
      w = this.$element.width();
      h = 100;
      left_pad = 20;
      pad = 20;
      minDate = moment.unix(this.commitData[this.commitData.length - 1].authorDate).toDate();
      maxDate = moment.unix(this.commitData[0].authorDate).toDate();
      minHour = d3.min(this.commitData.map(function(d) {
        return moment.unix(d.authorDate).hour();
      }));
      maxHour = d3.max(this.commitData.map(function(d) {
        return moment.unix(d.authorDate).hour();
      }));
      this.x = d3.time.scale().domain([minDate, maxDate]).range([left_pad, w - pad]);
      this.y = d3.scale.linear().domain([minHour, maxHour]).range([10, h - pad * 2]);
      xAxis = d3.svg.axis().scale(this.x).orient("bottom");
      yAxis = d3.svg.axis().scale(this.y).orient("left").ticks(0);
      svg.append("g").attr("class", "axis").attr("transform", "translate(0, " + (h - pad) + ")").call(xAxis);
      return svg.append("g").attr("class", "axis").attr("transform", "translate(" + (left_pad - pad) + ", 0)").call(yAxis);
    };

    GitTimeplot.prototype._renderBlobs = function(svg) {
      var max_r, r;
      max_r = d3.max(this.commitData.map(function(d) {
        return d.linesAdded + d.linesDeleted;
      }));
      r = d3.scale.linear().domain([0, max_r]).range([3, 15]);
      return svg.selectAll("circle").data(this.commitData).enter().append("circle").attr("class", "circle").attr("cx", (function(_this) {
        return function(d) {
          return _this.x(moment.unix(d.authorDate).toDate());
        };
      })(this)).attr("cy", (function(_this) {
        return function(d) {
          return _this.y(moment.unix(d.authorDate).hour());
        };
      })(this)).transition().duration(500).attr("r", function(d) {
        return r(d.linesAdded + d.linesDeleted || 0);
      });
    };

    GitTimeplot.prototype._renderHoverMarker = function() {
      var _this;
      this.$hoverMarker = this.$element.find('.hover-marker');
      if (!(this.$hoverMarker.length > 0)) {
        this.$hoverMarker = $("<div class='hover-marker'>");
        this.$element.append(this.$hoverMarker);
      }
      _this = this;
      this.$element.mouseenter(function(e) {
        return _this._onMouseenter(e);
      });
      this.$element.mousemove(function(e) {
        return _this._onMousemove(e);
      });
      this.$element.mouseleave(function(e) {
        return _this._onMouseleave(e);
      });
      this.$element.mousedown(function(e) {
        return _this._onMousedown(e);
      });
      return this.$element.mouseup(function(e) {
        return _this._onMouseup(e);
      });
    };

    GitTimeplot.prototype._onMouseenter = function(evt) {
      return this.isMouseInElement = true;
    };

    GitTimeplot.prototype._onMousemove = function(evt) {
      var relativeX;
      relativeX = evt.clientX - this.$element.offset().left;
      if (relativeX < this.$hoverMarker.offset().left) {
        this.$hoverMarker.css('left', relativeX);
      } else {
        this.$hoverMarker.css('left', relativeX - this.$hoverMarker.width());
      }
      if (this.isMouseDown) {
        this._hidePopup({
          force: true
        });
        return this._debouncedViewNearestRevision();
      } else {
        return this._debouncedRenderPopup();
      }
    };

    GitTimeplot.prototype._onMouseleave = function(evt) {
      this.isMouseInElement = false;
      this._debouncedHidePopup();
      return this.isMouseDown = false;
    };

    GitTimeplot.prototype._onMousedown = function(evt) {
      this.isMouseDown = true;
      this._hidePopup({
        force: true
      });
      return this._debouncedViewNearestRevision();
    };

    GitTimeplot.prototype._onMouseup = function(evt) {
      return this.isMouseDown = false;
    };

    GitTimeplot.prototype._renderPopup = function() {
      var commits, end, left, ref1, ref2, ref3, start;
      if ((ref1 = this.popup) != null ? ref1.isMouseInPopup() : void 0) {
        left = this.popup.offset().left - this.$element.offset().left;
        if (this._popupRightAligned) {
          left += this.popup.width() + 7;
        }
        this.$hoverMarker.css({
          'left': left
        });
        return;
      }
      if (!this.isMouseInElement) {
        return;
      }
      if ((ref2 = this.popup) != null) {
        ref2.hide().remove();
      }
      ref3 = this._filterCommitData(this.commitData), commits = ref3[0], start = ref3[1], end = ref3[2];
      this.popup = new GitTimeplotPopup(commits, this.editor, start, end);
      left = this.$hoverMarker.offset().left;
      if (left + this.popup.outerWidth() + 10 > this.$element.offset().left + this.$element.width()) {
        this._popupRightAligned = true;
        left -= this.popup.width() + 7;
      } else {
        this._popupRightAligned = false;
      }
      return this.popup.css({
        left: left,
        top: this.$element.offset().top - this.popup.height() - 10
      });
    };

    GitTimeplot.prototype._hidePopup = function(options) {
      var ref1, ref2;
      if (options == null) {
        options = {};
      }
      options = _.defaults(options, {
        force: false
      });
      if (!options.force && (((ref1 = this.popup) != null ? ref1.isMouseInPopup() : void 0) || this.isMouseInElement)) {
        return;
      }
      return (ref2 = this.popup) != null ? ref2.hide().remove() : void 0;
    };

    GitTimeplot.prototype._filterCommitData = function() {
      var commits, left, relativeLeft, tEnd, tStart;
      left = this.$hoverMarker.offset().left;
      relativeLeft = left - this.$element.offset().left - 5;
      tStart = moment(this.x.invert(relativeLeft)).startOf('hour').subtract(1, 'minute');
      tEnd = moment(this.x.invert(relativeLeft + 10)).endOf('hour').add(1, 'minute');
      commits = _.filter(this.commitData, function(c) {
        return moment.unix(c.authorDate).isBetween(tStart, tEnd);
      });
      return [commits, tStart, tEnd];
    };

    GitTimeplot.prototype._getNearestCommit = function() {
      var filteredCommitData, ref1, tEnd, tStart;
      ref1 = this._filterCommitData(), filteredCommitData = ref1[0], tStart = ref1[1], tEnd = ref1[2];
      if ((filteredCommitData != null ? filteredCommitData.length : void 0) > 0) {
        return filteredCommitData[0];
      } else {
        return _.find(this.commitData, function(c) {
          return moment.unix(c.authorDate).isBefore(tEnd);
        });
      }
    };

    GitTimeplot.prototype._viewNearestRevision = function() {
      var nearestCommit;
      nearestCommit = this._getNearestCommit();
      if (nearestCommit != null) {
        return RevisionView.showRevision(this.editor, nearestCommit.hash);
      }
    };

    return GitTimeplot;

  })();

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiL1VzZXJzL1JhZC8uYXRvbS9wYWNrYWdlcy9naXQtdGltZS1tYWNoaW5lL2xpYi9naXQtdGltZXBsb3QuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBO0FBQUEsTUFBQTs7RUFBQSxNQUFZLE9BQUEsQ0FBUSxzQkFBUixDQUFaLEVBQUMsU0FBRCxFQUFJOztFQUNKLENBQUEsR0FBSSxPQUFBLENBQVEsaUJBQVI7O0VBQ0osTUFBQSxHQUFTLE9BQUEsQ0FBUSxRQUFSOztFQUNULEVBQUEsR0FBSyxPQUFBLENBQVEsSUFBUjs7RUFFTCxnQkFBQSxHQUFtQixPQUFBLENBQVEsc0JBQVI7O0VBQ25CLFlBQUEsR0FBZSxPQUFBLENBQVEscUJBQVI7O0VBSWYsTUFBTSxDQUFDLE9BQVAsR0FBdUI7SUFFUixxQkFBQyxPQUFEO01BQUMsSUFBQyxDQUFBLFVBQUQ7TUFDWixJQUFDLENBQUEsUUFBRCxHQUFZLENBQUEsQ0FBRSxJQUFDLENBQUEsT0FBSDtNQUNaLElBQUMsQ0FBQSxxQkFBRCxHQUF5QixDQUFDLENBQUMsUUFBRixDQUFXLElBQUMsQ0FBQSxZQUFaLEVBQTBCLEVBQTFCO01BQ3pCLElBQUMsQ0FBQSxtQkFBRCxHQUF1QixDQUFDLENBQUMsUUFBRixDQUFXLElBQUMsQ0FBQSxVQUFaLEVBQXdCLEVBQXhCO01BQ3ZCLElBQUMsQ0FBQSw2QkFBRCxHQUFpQyxDQUFDLENBQUMsUUFBRixDQUFXLElBQUMsQ0FBQSxvQkFBWixFQUFrQyxHQUFsQztJQUp0Qjs7MEJBT2IsSUFBQSxHQUFNLFNBQUE7QUFDSixVQUFBOytDQUFNLENBQUUsTUFBUixDQUFBO0lBREk7OzBCQUlOLElBQUEsR0FBTSxTQUFBLEdBQUE7OzBCQU1OLE1BQUEsR0FBUSxTQUFDLE1BQUQsRUFBVSxVQUFWO0FBQ04sVUFBQTtNQURPLElBQUMsQ0FBQSxTQUFEO01BQVMsSUFBQyxDQUFBLGFBQUQ7O1lBQ1YsQ0FBRSxNQUFSLENB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LFFBQTFCLENBQW1DLElBQW5DO1FBQVAsQ0FBcEIsRUFIVDs7SUFGaUI7OzBCQVFuQixvQkFBQSxHQUFzQixTQUFBO0FBQ3BCLFVBQUE7TUFBQSxhQUFBLEdBQWlCLElBQUMsQ0FBQSxpQkFBRCxDQUFBO01BQ2pCLElBQUcscUJBQUg7ZUFDRSxZQUFZLENBQUMsWUFBYixDQUEwQixJQUFDLENBQUEsTUFBM0IsRUFBbUMsYUFBYSxDQUFDLElBQWpELEVBREY7O0lBRm9COzs7OztBQTdNeEIiLCJzb3VyY2VzQ29udGVudCI6WyJcbnskLCBWaWV3fSA9IHJlcXVpcmUgXCJhdG9tLXNwYWNlLXBlbi12aWV3c1wiXG5fID0gcmVxdWlyZSAndW5kZXJzY29yZS1wbHVzJ1xubW9tZW50ID0gcmVxdWlyZSAnbW9tZW50J1xuZDMgPSByZXF1aXJlICdkMydcblxuR2l0VGltZXBsb3RQb3B1cCA9IHJlcXVpcmUgJy4vZ2l0LXRpbWVwbG90LXBvcHVwJ1xuUmV2aXNpb25WaWV3ID0gcmVxdWlyZSAnLi9naXQtcmV2aXNpb24tdmlldydcblxuXG5cbm1vZHVsZS5leHBvcnRzID0gY2xhc3MgR2l0VGltZXBsb3RcblxuICBjb25zdHJ1Y3RvcjogKEBlbGVtZW50KSAtPlxuICAgIEAkZWxlbWVudCA9ICQoQGVsZW1lbnQpXG4gICAgQF9kZWJvdW5jZWRSZW5kZXJQb3B1cCA9IF8uZGVib3VuY2UoQF9yZW5kZXJQb3B1cCwgNTApXG4gICAgQF9kZWJvdW5jZWRIaWRlUG9wdXAgPSBfLmRlYm91bmNlKEBfaGlkZVBvcHVwLCA1MClcbiAgICBAX2RlYm91bmNlZFZpZXdOZWFyZXN0UmV2aXNpb24gPSBfLmRlYm91bmNlKEBfdmlld05lYXJlc3RSZXZpc2lvbiwgMTAwKVxuXG5cbiAgaGlkZTogKCkgLT5cbiAgICBAcG9wdXA/LnJlbW92ZSgpXG5cblxuICBzaG93OiAoKSAtPlxuICAgICMgIG5vdGhpbmcgdG8gZG8gaGVyZVxuXG5cbiAgIyBAY29tbWl0RGF0YSAtIGFycmF5IG9mIGphdmFzY3JpcHQgb2JqZWN0cyBsaWtlIHRob3NlIHJldHVybmVkIGJ5IEdpdFV0aWxzLmdldEZpbGVDb21taXRIaXN0b3J5XG4gICMgICAgICAgICAgICAgICBzaG91bGQgYmUgaW4gcmV2ZXJzZSBjaHJvbiBvcmRlclxuICByZW5kZXI6IChAZWRpdG9yLCBAY29tbWl0RGF0YSkgLT5cbiAgICBAcG9wdXA/LnJlbW92ZSgpXG5cbiAgICBAZmlsZSA9IEBlZGl0b3IuZ2V0UGF0aCgpXG5cbiAgICBAJHRpbWVwbG90ID0gQCRlbGVtZW50LmZpbmQoJy50aW1lcGxvdCcpXG4gICAgaWYgQCR0aW1lcGxvdC5sZW5ndGggPD0gMFxuICAgICAgQCR0aW1lcGxvdCA9ICQoXCI8ZGl2IGNsYXNzPSd0aW1lcGxvdCc+XCIpXG4gICAgICBAJGVsZW1lbnQuYXBwZW5kIEAkdGltZXBsb3RcblxuICAgIGlmIEBjb21taXREYXRhLmxlbmd0aCA8PSAwXG4gICAgICBAJHRpbWVwbG90Lmh0bWwoXCI8ZGl2IGNsYXNzPSdwbGFjZWhvbGRlcic+Tm8gY29tbWl0cywgbm90aGluZyB0byBzZWUgaGVyZS48L2Rpdj5cIilcbiAgICAgIHJldHVybjtcblxuICAgIHN2ZyA9IGQzLnNlbGVjdChAJHRpbWVwbG90LmdldCgwKSlcbiAgICAuYXBwZW5kKFwic3ZnXCIpXG4gICAgLmF0dHIoXCJ3aWR0aFwiLCBAJGVsZW1lbnQud2lkdGgoKSlcbiAgICAuYXR0cihcImhlaWdodFwiLCAxMDApXG5cbiAgICBAX3JlbmRlckF4aXMoc3ZnKVxuICAgIEBfcmVuZGVyQmxvYnMoc3ZnKVxuXG4gICAgQF9yZW5kZXJIb3Zlck1hcmtlcigpXG5cbiAgICByZXR1cm4gQCR0aW1lcGxvdDtcblxuXG4gIF9yZW5kZXJBeGlzOiAoc3ZnKSAtPlxuICAgIHcgPSBAJGVsZW1lbnQud2lkdGgoKVxuICAgIGggPSAxMDBcbiAgICBsZWZ0X3BhZCA9IDIwXG4gICAgcGFkID0gMjBcbiAgICBtaW5EYXRlID0gbW9tZW50LnVuaXgoQGNvbW1pdERhdGFbQGNvbW1pdERhdGEubGVuZ3RoLTFdLmF1dGhvckRhdGUpLnRvRGF0ZSgpXG4gICAgbWF4RGF0ZSA9IG1vbWVudC51bml4KEBjb21taXREYXRhWzBdLmF1dGhvckRhdGUpLnRvRGF0ZSgpXG4gICAgbWluSG91ciA9IGQzLm1pbihAY29tbWl0RGF0YS5tYXAoKGQpLT5tb21lbnQudW5peChkLmF1dGhvckRhdGUpLmhvdXIoKSkpXG4gICAgbWF4SG91ciA9IGQzLm1heChAY29tbWl0RGF0YS5tYXAoKGQpLT5tb21lbnQudW5peChkLmF1dGhvckRhdGUpLmhvdXIoKSkpXG5cbiAgICBAeCA9IGQzLnRpbWUuc2NhbGUoKS5kb21haW4oW21pbkRhdGUsIG1heERhdGVdKS5yYW5nZShbbGVmdF9wYWQsIHctcGFkXSlcbiAgICBAeSA9IGQzLnNjYWxlLmxpbmVhcigpLmRvbWFpbihbbWluSG91ciwgbWF4SG91cl0pLnJhbmdlKFsxMCwgaC1wYWQqMl0pXG5cbiAgICB4QXhpcyA9IGQzLnN2Zy5heGlzKCkuc2NhbGUoQHgpLm9yaWVudChcImJvdHRvbVwiKVxuICAgIHlBeGlzID0gZDMuc3ZnLmF4aXMoKS5zY2FsZShAeSkub3JpZW50KFwibGVmdFwiKS50aWNrcygwKVxuXG4gICAgc3ZnLmFwcGVuZChcImdcIilcbiAgICAuYXR0cihcImNsYXNzXCIsIFwiYXhpc1wiKVxuICAgIC5hdHRyKFwidHJhbnNmb3JtXCIsIFwidHJhbnNsYXRlKDAsICN7aC1wYWR9KVwiKVxuICAgIC5jYWxsKHhBeGlzKTtcblxuICAgIHN2Zy5hcHBlbmQoXCJnXCIpXG4gICAgLmF0dHIoXCJjbGFzc1wiLCBcImF4aXNcIilcbiAgICAuYXR0cihcInRyYW5zZm9ybVwiLCBcInRyYW5zbGF0ZSgje2xlZnRfcGFkLXBhZH0sIDApXCIpXG4gICAgLmNhbGwoeUF4aXMpO1xuXG5cbiAgX3JlbmRlckJsb2JzOiAoc3ZnKSAtPlxuICAgIG1heF9yID0gZDMubWF4KEBjb21taXREYXRhLm1hcCgoZCktPnJldHVybiBkLmxpbmVzQWRkZWQgKyBkLmxpbmVzRGVsZXRlZCkpXG4gICAgciA9IGQzLnNjYWxlLmxpbmVhcigpXG4gICAgLmRvbWFpbihbMCwgbWF4X3JdKVxuICAgIC5yYW5nZShbMywgMTVdKVxuXG4gICAgc3ZnLnNlbGVjdEFsbChcImNpcmNsZVwiKVxuICAgIC5kYXRhKEBjb21taXREYXRhKVxuICAgIC5lbnRlcigpXG4gICAgLmFwcGVuZChcImNpcmNsZVwiKVxuICAgIC5hdHRyKFwiY2xhc3NcIiwgXCJjaXJjbGVcIilcbiAgICAuYXR0cihcImN4XCIsIChkKT0+IEB4KG1vbWVudC51bml4KGQuYXV0aG9yRGF0ZSkudG9EYXRlKCkpKVxuICAgIC5hdHRyKFwiY3lcIiwgKGQpPT4gQHkobW9tZW50LnVuaXgoZC5hdXRob3JEYXRlKS5ob3VyKCkpKVxuICAgIC50cmFuc2l0aW9uKClcbiAgICAuZHVyYXRpb24oNTAwKVxuICAgIC5hdHRyKFwiclwiLCAoZCkgLT4gcihkLmxpbmVzQWRkZWQgKyBkLmxpbmVzRGVsZXRlZCB8fCAwKSlcblxuXG4gICMgaG92ZXIgbWFya2VyIGlzIHRoZSBncmVlbiB2ZXJ0aWNhbCBsaW5lIHRoYXQgZm9sbG93cyB0aGUgbW91c2Ugb24gdGhlIHRpbWVwbG90XG4gIF9yZW5kZXJIb3Zlck1hcmtlcjogKCkgLT5cbiAgICBAJGhvdmVyTWFya2VyID0gQCRlbGVtZW50LmZpbmQoJy5ob3Zlci1tYXJrZXInKVxuICAgIHVubGVzcyBAJGhvdmVyTWFya2VyLmxlbmd0aCA+IDBcbiAgICAgIEAkaG92ZXJNYXJrZXIgPSAkKFwiPGRpdiBjbGFzcz0naG92ZXItbWFya2VyJz5cIilcbiAgICAgIEAkZWxlbWVudC5hcHBlbmQoQCRob3Zlck1hcmtlcilcblxuICAgIF90aGlzID0gQFxuICAgIEAkZWxlbWVudC5tb3VzZWVudGVyIChlKSAtPiBfdGhpcy5fb25Nb3VzZWVudGVyKGUpXG4gICAgQCRlbGVtZW50Lm1vdXNlbW92ZSAoZSkgLT4gX3RoaXMuX29uTW91c2Vtb3ZlKGUpXG4gICAgQCRlbGVtZW50Lm1vdXNlbGVhdmUgKGUpIC0+IF90aGlzLl9vbk1vdXNlbGVhdmUoZSlcbiAgICBAJGVsZW1lbnQubW91c2Vkb3duIChlKSAtPiBfdGhpcy5fb25Nb3VzZWRvd24oZSlcbiAgICBAJGVsZW1lbnQubW91c2V1cCAoZSkgLT4gX3RoaXMuX29uTW91c2V1cChlKVxuXG5cbiAgX29uTW91c2VlbnRlcjogKGV2dCkgLT5cbiAgICBAaXNNb3VzZUluRWxlbWVudCA9IHRydWVcblxuXG4gIF9vbk1vdXNlbW92ZTogKGV2dCkgLT5cbiAgICByZWxhdGl2ZVggPSBldnQuY2xpZW50WCAtIEAkZWxlbWVudC5vZmZzZXQoKS5sZWZ0XG4gICAgaWYgcmVsYXRpdmVYIDwgQCRob3Zlck1hcmtlci5vZmZzZXQoKS5sZWZ0XG4gICAgICBAJGhvdmVyTWFya2VyLmNzcygnbGVmdCcsIHJlbGF0aXZlWClcbiAgICBlbHNlXG4gICAgICBAJGhvdmVyTWFya2VyLmNzcygnbGVmdCcsIHJlbGF0aXZlWCAtIEAkaG92ZXJNYXJrZXIud2lkdGgoKSlcblxuICAgIGlmIEBpc01vdXNlRG93blxuICAgICAgQF9oaWRlUG9wdXAoZm9yY2U6IHRydWUpXG4gICAgICBAX2RlYm91bmNlZFZpZXdOZWFyZXN0UmV2aXNpb24oKVxuICAgIGVsc2VcbiAgICAgIEBfZGVib3VuY2VkUmVuZGVyUG9wdXAoKVxuXG5cbiAgX29uTW91c2VsZWF2ZTogKGV2dCkgLT5cbiAgICBAaXNNb3VzZUluRWxlbWVudCA9IGZhbHNlXG4gICAgIyBkZWJvdW5jaW5nIGdpdmVzIGEgbGl0dGxlIHRpbWUgdG8gZ2V0IHRoZSBtb3VzZSBpbnRvIHRoZSBwb3B1cFxuICAgIEBfZGVib3VuY2VkSGlkZVBvcHVwKCk7XG4gICAgQGlzTW91c2VEb3duID0gZmFsc2VcblxuXG4gIF9vbk1vdXNlZG93bjogKGV2dCkgLT5cbiAgICBAaXNNb3VzZURvd24gPSB0cnVlXG4gICAgQF9oaWRlUG9wdXAoZm9yY2U6IHRydWUpXG4gICAgQF9kZWJvdW5jZWRWaWV3TmVhcmVzdFJldmlzaW9uKClcblxuXG4gIF9vbk1vdXNldXA6IChldnQpIC0+XG4gICAgQGlzTW91c2VEb3duID0gZmFsc2VcblxuXG4gIF9yZW5kZXJQb3B1cDogKCkgLT5cbiAgICAjIHJlcG9zaXRpb24gdGhlIG1hcmtlciB0byBtYXRjaCB0aGUgcG9zaXRpb24gb2YgdGhlIGN1cnJlbnQgcG9wdXBcbiAgICBpZiBAcG9wdXA/LmlzTW91c2VJblBvcHVwKClcbiAgICAgIGxlZnQgPSBAcG9wdXAub2Zmc2V0KCkubGVmdCAtIEAkZWxlbWVudC5vZmZzZXQoKS5sZWZ0XG4gICAgICBpZiBAX3BvcHVwUmlnaHRBbGlnbmVkXG4gICAgICAgIGxlZnQgKz0gKEBwb3B1cC53aWR0aCgpICsgNylcbiAgICAgIEAkaG92ZXJNYXJrZXIuY3NzICdsZWZ0JzogbGVmdFxuICAgICAgcmV0dXJuXG5cbiAgICByZXR1cm4gdW5sZXNzIEBpc01vdXNlSW5FbGVtZW50XG5cbiAgICBAcG9wdXA/LmhpZGUoKS5yZW1vdmUoKVxuICAgIFtjb21taXRzLCBzdGFydCwgZW5kXSA9IEBfZmlsdGVyQ29tbWl0RGF0YShAY29tbWl0RGF0YSlcbiAgICBAcG9wdXAgPSBuZXcgR2l0VGltZXBsb3RQb3B1cChjb21taXRzLCBAZWRpdG9yLCBzdGFydCwgZW5kKVxuXG4gICAgbGVmdCA9IEAkaG92ZXJNYXJrZXIub2Zmc2V0KCkubGVmdFxuICAgIGlmIGxlZnQgKyBAcG9wdXAub3V0ZXJXaWR0aCgpICsgMTAgPiBAJGVsZW1lbnQub2Zmc2V0KCkubGVmdCArIEAkZWxlbWVudC53aWR0aCgpXG4gICAgICBAX3BvcHVwUmlnaHRBbGlnbmVkID0gdHJ1ZVxuICAgICAgbGVmdCAtPSAoQHBvcHVwLndpZHRoKCkgKyA3KVxuICAgIGVsc2VcbiAgICAgIEBfcG9wdXBSaWdodEFsaWduZWQgPSBmYWxzZVxuXG4gICAgQHBvcHVwLmNzc1xuICAgICAgbGVmdDogbGVmdFxuICAgICAgdG9wOiBAJGVsZW1lbnQub2Zmc2V0KCkudG9wIC0gQHBvcHVwLmhlaWdodCgpIC0gMTBcblxuXG4gIF9oaWRlUG9wdXA6IChvcHRpb25zPXt9KSAtPlxuICAgIG9wdGlvbnMgPSBfLmRlZmF1bHRzIG9wdGlvbnMsXG4gICAgICBmb3JjZTogZmFsc2VcblxuICAgIHJldHVybiBpZiAhb3B0aW9ucy5mb3JjZSAmJiAoQHBvcHVwPy5pc01vdXNlSW5Qb3B1cCgpIHx8IEBpc01vdXNlSW5FbGVtZW50KVxuICAgIEBwb3B1cD8uaGlkZSgpLnJlbW92ZSgpXG5cblxuICAjIHJldHVybiBjb21taXRzIGZvciByYW5nZSBvZiB0aW1lIGF0IGhvdmVyIG1hcmtlciAobW91c2UgaG92ZXIgcG9pbnQgKy8tIGZpeCByYWRpdXMpXG4gIF9maWx0ZXJDb21taXREYXRhOiAoKSAtPlxuICAgIGxlZnQgPSBAJGhvdmVyTWFya2VyLm9mZnNldCgpLmxlZnRcbiAgICByZWxhdGl2ZUxlZnQgPSBsZWZ0IC0gQCRlbGVtZW50Lm9mZnNldCgpLmxlZnQgLSA1XG4gICAgdFN0YXJ0ID0gbW9tZW50KEB4LmludmVydChyZWxhdGl2ZUxlZnQpKS5zdGFydE9mKCdob3VyJykuc3VidHJhY3QoMSwgJ21pbnV0ZScpXG4gICAgdEVuZCA9IG1vbWVudChAeC5pbnZlcnQocmVsYXRpdmVMZWZ0ICsgMTApKS5lbmRPZignaG91cicpLmFkZCgxLCAnbWludXRlJylcbiAgICBjb21taXRzID0gXy5maWx0ZXIgQGNvbW1pdERhdGEsIChjKSAtPiBtb21lbnQudW5peChjLmF1dGhvckRhdGUpLmlzQmV0d2Vlbih0U3RhcnQsIHRFbmQpXG4gICAgIyBjb25zb2xlLmxvZyhcImd0bTogaW5zcGVjdGluZyAje2NvbW1pdHMubGVuZ3RofSBjb21taXRzIGJldHdlZSAje3RTdGFydC50b1N0cmluZygpfSAtICN7dEVuZC50b1N0cmluZygpfVwiKVxuICAgIHJldHVybiBbY29tbWl0cywgdFN0YXJ0LCB0RW5kXTtcblxuICAjIHJldHVybiB0aGUgbmVhcmVzdCBjb21taXQgdG8gaG92ZXIgbWFya2VyIG9yIHByZXZpb3VzXG4gIF9nZXROZWFyZXN0Q29tbWl0OiAoKSAtPlxuICAgIFtmaWx0ZXJlZENvbW1pdERhdGEsIHRTdGFydCwgdEVuZF0gPSBAX2ZpbHRlckNvbW1pdERhdGEoKVxuICAgIGlmIGZpbHRlcmVkQ29tbWl0RGF0YT8ubGVuZ3RoID4gMFxuICAgICAgcmV0dXJuIGZpbHRlcmVkQ29tbWl0RGF0YVswXVxuICAgIGVsc2VcbiAgICAgIHJldHVybiBfLmZpbmQgQGNvbW1pdERhdGEsIChjKSAtPiBtb21lbnQudW5peChjLmF1dGhvckRhdGUpLmlzQmVmb3JlKHRFbmQpXG5cblxuICBfdmlld05lYXJlc3RSZXZpc2lvbjogKCkgLT5cbiAgICBuZWFyZXN0Q29tbWl0ID0gIEBfZ2V0TmVhcmVzdENvbW1pdCgpXG4gICAgaWYgbmVhcmVzdENvbW1pdD9cbiAgICAgIFJldmlzaW9uVmlldy5zaG93UmV2aXNpb24oQGVkaXRvciwgbmVhcmVzdENvbW1pdC5oYXNoKVxuIl19
